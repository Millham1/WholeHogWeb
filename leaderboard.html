<script>
(function(){
  // Utility
  function $(s){ return document.querySelector(s); }
  function getArr(k){ try{ var v = localStorage.getItem(k); return v ? JSON.parse(v) : []; }catch(e){ return []; } }
  function toInt(v){ var n = Number(v); return isFinite(n) ? Math.trunc(n) : 0; }

  // BLIND - only utilized chips
  function paintBlind(){
    var host = $('#blind-list');
    if (!host) return;
    var rows = getArr('blindTasteEntries');
    var chips = {};
    rows.forEach(r=>{
      var chip = r.chip_number || r.chip;
      if (!chip) return;
      chips[chip] = (chips[chip]||0) + toInt(r.score_total || r.score);
    });
    var html = Object.entries(chips)
      .sort((a,b)=>b[1]-a[1])
      .map(([chip,score])=>`<div class="row"><div><strong>Chip #${chip}</strong></div><div class="score">${score}</div></div>`)
      .join('');
    host.innerHTML = html || '<div class="muted">No blind tasting scores yet.</div>';
  }

  // SAUCE - only utilized chips
  function paintSauce(){
    var host = $('#sauce-list');
    if (!host) return;
    var rows = getArr('sauceScores');
    var chips = {};
    rows.forEach(r=>{
      var chip = r.chip || r.chip_number;
      if (!chip) return;
      chips[chip] = (chips[chip]||0) + toInt(r.score);
    });
    var html = Object.entries(chips)
      .sort((a,b)=>b[1]-a[1])
      .map(([chip,score])=>`<div class="row"><div><strong>Chip #${chip}</strong></div><div class="score">${score}</div></div>`)
      .join('');
    host.innerHTML = html || '<div class="muted">No sauce tasting scores yet.</div>';
  }

  function paintOnsite(){
    var host = $('#onsite-list');
    if (!host) return;
    host.innerHTML = '<div class="muted">On-site leaderboard coming soon.</div>';
  }

  function paintAll(){
    paintOnsite();
    paintBlind();
    paintSauce();
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', paintAll); else paintAll();
  document.addEventListener('visibilitychange', function(){ if (!document.hidden) paintAll(); });
  window.addEventListener('storage', function(e){ paintAll(); });
})();
</script>