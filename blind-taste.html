<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Blind Taste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    form { display: grid; gap: 12px; max-width: 560px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { display: grid; gap: 6px; }
    input, select, button { padding: 8px; font-size: 16px; }
    button { cursor: pointer; }
    .score-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .score-selected { background: yellow !important; color: black !important; }
    label.score-selected { border-radius: 4px; padding: 2px 4px; }
    .note { font-size: 13px; color: #555; }
  </style>
  <link rel="stylesheet" href="./bt-style.css">
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
</head>
<body>
  <header style="text-align:center; padding:20px;">
    <h1>Blind Taste</h1>
  </header>
  <div style="display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:20px;">
    <button type="button" onclick="location.href='landing.html'" style="padding:8px 12px;cursor:pointer;">Go to Landing</button>
    <button type="button" onclick="location.href='onsite.html'" style="padding:8px 12px;cursor:pointer;">Go to On-Site</button>
    <button type="button" onclick="location.href='leaderboard.html'" style="padding:8px 12px;cursor:pointer;">Go to Leaderboard</button>
    <button type="button" onclick="location.href='sauce.html'" style="padding:8px 12px;cursor:pointer;">Go to Sauce</button>
  </div>

  <form id="blind-taste-form">
    <div class="row">
      <label>Judge
        <select id="judge-select" name="judge" required>
          <option value="" selected disabled>Select judge…</option>
        </select>
      </label>

      <label>Chip #
        <select id="chip-select" name="chip" required>
          <option value="" selected disabled>Loading chips…</option>
        </select>
        <div class="note">Numbers only; duplicates (same Judge + Chip) are blocked.</div>
      </label>
    </div>

    <div class="score-grid">
      <label>Appearance
        <input class="score-field" data-score name="appearance" type="number" min="0" step="1" placeholder="0-10">
      </label>
      <label>Tenderness
        <input class="score-field" data-score name="tenderness" type="number" min="0" step="1" placeholder="0-10">
      </label>
      <label>Flavor
        <input class="score-field" data-score name="flavor" type="number" min="0" step="1" placeholder="0-10">
      </label>
    </div>

    <label>Total
      <input id="score-total" name="score_total" type="number" readonly>
    </label>

    <button id="save-blind-taste" type="button">Save Blind Taste</button>
  </form>

  <script>
  (function(){
    function waitForSupabase(callback) {
      if (window.supabase && typeof window.supabase.from === 'function') {
        callback(window.supabase);
      } else {
        setTimeout(() => waitForSupabase(callback), 100);
      }
    }

    function $(sel){ return document.querySelector(sel); }
    function $all(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }

    function setHighlight(el,on){
      if (!el) return;
      if (el.tagName === "INPUT" && el.type === "radio"){
        var lbl = el.closest("label"); if (lbl) { lbl.classList.toggle("score-selected", !!on); return; }
      }
      el.classList.toggle("score-selected", !!on);
    }

    function wireHighlighting(){
      $all("input[data-score], input.score-field").forEach(function(inp){
        var upd = function(){
          var v = (inp.value==null ? "" : String(inp.value).trim());
          setHighlight(inp, v !== "" && !Number.isNaN(Number(v)));
        };
        inp.addEventListener("input", upd, {passive:true});
        inp.addEventListener("change", upd, {passive:true});
        upd();
      });
    }

    function computeTotal(){
      var total = 0;
      $all("input[data-score], input.score-field").forEach(function(c){
        var v = (c.value==null ? "" : String(c.value).trim());
        var n = Number(v);
        if (!Number.isNaN(n)) total += n;
      });
      var totalEl = $("#score-total");
      if (totalEl) totalEl.value = String(total);
      return total;
    }

    async function loadChips(sb){
      var sel = $("#chip-select");
      if (!sel) return;
      try {
        const { data: teams, error } = await sb.from('teams').select('chip_number').order('chip_number', { ascending: true });
        if (error) throw error;
        
        sel.innerHTML = '<option value="" disabled selected>Select chip #</option>';
        (teams || []).forEach(function(r){
          if (r && r.chip_number != null){
            var n = String(r.chip_number);
            var o = document.createElement("option");
            o.value = n; o.textContent = n;
            sel.appendChild(o);
          }
        });
      } catch (e) {
        console.error("loadChips error", e);
        sel.innerHTML = '<option value="" disabled selected>Error loading chips</option>';
      }
    }

    async function loadJudges(sb){
      var sel = $("#judge-select");
      if (!sel) return;
      try {
        const { data: judges, error } = await sb.from('judges').select('*').order('name', { ascending: true });
        if (error) throw error;
        
        sel.innerHTML = '<option value="" disabled selected>Select judge…</option>';
        (judges || []).forEach(function(j){
          var o = document.createElement("option");
          o.value = j.id; o.textContent = j.name;
          sel.appendChild(o);
        });
      } catch (e) {
        console.error("loadJudges error", e);
        sel.innerHTML = '<option value="" disabled selected>Error loading judges</option>';
      }
    }

    async function duplicateExists(sb, judgeId, chipNum){
      const { data, error } = await sb.from('blind_taste')
        .select('id')
        .eq('judge_id', judgeId)
        .eq('chip_number', chipNum)
        .maybeSingle();
      if (error) {
        console.error("duplicate check error", error);
        return false;
      }
      return !!data;
    }

    function clearForm(){
      var form = $("#blind-taste-form");
      if (form && form.reset) form.reset();
      $all(".score-selected").forEach(function(el){ el.classList.remove("score-selected"); });
      computeTotal();
    }

    async function onSave(sb){
      var judgeId = ($("#judge-select")?.value || "").trim();
      var chipRaw = ($("#chip-select")?.value || "").trim();
      var chipNum = Number(chipRaw);

      if (!judgeId){ alert("Please select a Judge."); return; }
      if (!chipRaw || Number.isNaN(chipNum) || chipNum <= 0){ alert("Please select a valid Chip #."); return; }

      var app = Number(($("#blind-taste-form [name='appearance']")?.value || "").trim());
      var ten = Number(($("#blind-taste-form [name='tenderness']")?.value || "").trim());
      var fla = Number(($("#blind-taste-form [name='flavor']")?.value || "").trim());
      
      if (Number.isNaN(app) || Number.isNaN(ten) || Number.isNaN(fla)){
        alert("Please enter all scores.");
        return;
      }

      var total = computeTotal();
      var row = { 
        judge_id: judgeId, 
        chip_number: chipNum, 
        score_total: total,
        score_appearance: app,
        score_tenderness: ten,
        score_flavor: fla
      };

      if (await duplicateExists(sb, judgeId, chipNum)){
        alert("This Judge + Chip # has already been saved.");
        return;
      }

      var btn = $("#save-blind-taste"); if (btn) btn.disabled = true;
      
      const { data, error } = await sb.from('blind_taste').insert([row]).select().single();
      
      if (btn) btn.disabled = false;

      if (error){
        console.error("insert error", error);
        alert(error.message || "Save failed.");
        return;
      }

      alert("Saved! Chip #" + data.chip_number + ", Judge " + judgeId + ".");
      clearForm();
    }

    waitForSupabase(function(sb){
      wireHighlighting();
      computeTotal();
      loadChips(sb);
      loadJudges(sb);
      
      var btn = $("#save-blind-taste");
      if (btn){ btn.addEventListener("click", function(e){ e.preventDefault(); onSave(sb); }); }
      else {
        var form = $("#blind-taste-form");
        if (form){ form.addEventListener("submit", function(e){ e.preventDefault(); onSave(sb); }); }
      }
      
      // Auto-compute total on input
      $all("input[data-score], input.score-field").forEach(function(inp){
        inp.addEventListener("input", computeTotal);
        inp.addEventListener("change", computeTotal);
      });
    });
  })();
  </script>
</body>
</html>
